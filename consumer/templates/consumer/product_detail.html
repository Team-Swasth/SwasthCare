{% extends 'base.html' %}

{% block title %}SwasthCare - {{ product.prod_name }}{% endblock %}

{% block content %}
<a href="/consumer/scan/" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Back to Scanner
</a>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0">{{ product.prod_name }}</h3>
        <span class="badge bg-secondary">{{ product.prod_type }}</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h5>Product Information</h5>
                <p><strong>Barcode:</strong> {{ product.barcode }}</p>
                <p><strong>Price:</strong> â‚¹{{ product.price }}</p>

                <div class="date-info">
                    <div><strong>Manufacturing Date:</strong> {{ product.manufacturing_date }}</div>
                    <div><strong>Expiry Date:</strong> {{ product.expiry.expiry_date }}</div>
                    <div><strong>Shelf Life:</strong> {{ product.expiry.tenure }} months</div>
                </div>

                {% if product.special_diet %}
                <div class="mt-3">
                    <h6>Special Diet:</h6>
                    {% for diet in product.special_diet %}
                    <span class="badge badge-diet">{{ diet|title }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if product.allergen_info %}
                <div class="mt-3">
                    <h6>Allergen Information:</h6>
                    <div class="badge badge-allergen">{{ product.allergen_info }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <hr>

        <div class="row mt-3">
            <div class="col-md-12">
                <h5>Ingredients</h5>
                <p>{{ product.ingredients }}</p>
            </div>
        </div>

        <hr>

        <div class="row mt-3">
            <div class="col-md-12">
                <h5>Nutritional Information (per serving)</h5>
                <table class="nutrient-table">
                    <tr>
                        <td><strong>Energy</strong></td>
                        <td>{{ product.nutritional_info.energy_kcal }} kcal</td>
                    </tr>
                    <tr>
                        <td><strong>Protein</strong></td>
                        <td>{{ product.nutritional_info.protein_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Total Fat</strong></td>
                        <td>{{ product.nutritional_info.total_fat_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Saturated Fat</strong></td>
                        <td>{{ product.nutritional_info.saturated_fat_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Trans Fat</strong></td>
                        <td>{{ product.nutritional_info.trans_fat_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Cholesterol</strong></td>
                        <td>{{ product.nutritional_info.cholesterol_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Carbohydrates</strong></td>
                        <td>{{ product.nutritional_info.carbohydrate_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Sugars</strong></td>
                        <td>{{ product.nutritional_info.sugars_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Fiber</strong></td>
                        <td>{{ product.nutritional_info.fiber_g }} g</td>
                    </tr>
                    <tr>
                        <td><strong>Sodium</strong></td>
                        <td>{{ product.nutritional_info.sodium_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Calcium</strong></td>
                        <td>{{ product.nutritional_info.calcium_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Iron</strong></td>
                        <td>{{ product.nutritional_info.iron_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Potassium</strong></td>
                        <td>{{ product.nutritional_info.potassium_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Vitamin C</strong></td>
                        <td>{{ product.nutritional_info.vitamin_c_mg }} mg</td>
                    </tr>
                    <tr>
                        <td><strong>Vitamin D</strong></td>
                        <td>{{ product.nutritional_info.vitamin_d_mcg }} mcg</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chatbot Button and Window -->
<style>
    #floating-chatbot-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 1050;
        background: #0a58ca;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    #floating-chatbot-window {
        position: fixed;
        bottom: 100px;
        right: 32px;
        width: 340px;
        max-width: 95vw;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
        z-index: 1060;
        display: none;
        flex-direction: column;
        overflow: hidden;
        color: #212529;
    }

    #floating-chatbot-header {
        background: #0a58ca;
        color: #fff;
        padding: 12px 16px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #floating-chatbot-close {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.3rem;
        cursor: pointer;
    }

    #floating-chatbot-history {
        padding: 12px;
        background: #fafbfc;
        flex: 1 1 auto;
        max-height: 260px;
        overflow-y: auto;
        font-size: 0.97rem;
        color: #212529;
    }

    #floating-chatbot-form {
        padding: 10px;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }

    #floating-chatbot-form .input-group {
        width: 100%;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        #floating-chatbot-window {
            background: #23272b;
            color: #f8f9fa;
        }

        #floating-chatbot-header {
            background: #222b3a;
            color: #f8f9fa;
        }

        #floating-chatbot-close {
            color: #f8f9fa;
        }

        #floating-chatbot-history {
            background: #181a1b;
            color: #f8f9fa;
        }

        #floating-chatbot-form {
            background: #23272b;
        }

        #floating-chatbot-btn {
            background: #375a7f;
            color: #fff;
        }
    }
</style>

<button id="floating-chatbot-btn" title="Ask about this product">
    <i class="bi bi-chat-dots"></i>
</button>
<div id="floating-chatbot-window">
    <div id="floating-chatbot-header">
        Ask about this product
        <button id="floating-chatbot-close" title="Close">&times;</button>
    </div>
    <div id="floating-chatbot-history"></div>
    <form id="floating-chatbot-form" autocomplete="off">
        <div class="input-group">
            <input type="text" id="floating-chatbot-question" class="form-control" placeholder="Type your question..."
                required>
            <button type="submit" class="btn btn-primary">Ask</button>
        </div>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Elements
        const btn = document.getElementById("floating-chatbot-btn");
        const win = document.getElementById("floating-chatbot-window");
        const closeBtn = document.getElementById("floating-chatbot-close");
        const form = document.getElementById("floating-chatbot-form");
        const questionInput = document.getElementById("floating-chatbot-question");
        const historyDiv = document.getElementById("floating-chatbot-history");
        let chatHistory = [];

        // Show/hide logic
        btn.addEventListener("click", function () {
            win.style.display = "flex";
            setTimeout(() => questionInput.focus(), 100);
        });
        closeBtn.addEventListener("click", function () {
            win.style.display = "none";
        });

        // Render chat history
        function renderHistory() {
            historyDiv.innerHTML = "";
            chatHistory.forEach(entry => {
                const qDiv = document.createElement("div");
                qDiv.className = "mb-1";
                qDiv.innerHTML = `<span style="font-weight:600;color:#2c3e50;">You:</span> ${entry.question}`;
                historyDiv.appendChild(qDiv);

                const aDiv = document.createElement("div");
                aDiv.className = "mb-2";
                aDiv.innerHTML = `<span style="font-weight:600;color:#0a58ca;">Bot:</span> ${entry.answer}`;
                historyDiv.appendChild(aDiv);
            });
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // Handle form submit
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;
            chatHistory.push({ question: question, answer: "<em>Thinking...</em>" });
            renderHistory();
            questionInput.value = "";
            fetch("{% url 'product_chatbot' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    barcode: "{{ product.barcode }}",
                    question: question
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (chatHistory.length > 0) {
                        if (data.answer) {
                            chatHistory[chatHistory.length - 1].answer = data.answer;
                        } else if (data.error) {
                            chatHistory[chatHistory.length - 1].answer = `<span class='text-danger'>${data.error}</span>`;
                        } else {
                            chatHistory[chatHistory.length - 1].answer = "<span class='text-danger'>No response.</span>";
                        }
                        renderHistory();
                    }
                })
                .catch(() => {
                    if (chatHistory.length > 0) {
                        chatHistory[chatHistory.length - 1].answer = "<span class='text-danger'>Error contacting chatbot.</span>";
                        renderHistory();
                    }
                });
        });
    });
</script>
{% endblock %}